---
import fs from "node:fs";
import { minify } from "terser";
import buildScript from "./script.js";

export interface props {
  beautify: boolean;
  cache: boolean;
  delay: number;
  external: boolean;
  highPriorityPrefetch: boolean;
  ignores: string[];
  limit: number;
  prefetch: boolean;
  prefetchUpgradation: boolean;
  root: string;
  rootMargin: string;
  threshold: number;
  timeout: number;
}

const {
  beautify = false,
  cache = true,
  delay = 500,
  external = false,
  highPriorityPrefetch = false,
  ignores,
  limit,
  prefetch = true,
  prefetchUpgradation = true,
  root,
  rootMargin,
  threshold = 0.25,
  timeout = 2000,
  
} = Astro.props as props;

const scriptContent = buildScript(
  cache,
  delay,
  highPriorityPrefetch,
  ignores,
  limit,
  prefetch,
  prefetchUpgradation,
  root,
  rootMargin,
  threshold,
  timeout,
);

script = JSON.stringify(await minify(scriptContent, { format : { beautify } }));

fs.writeFileSync("node_modules/astro-spa/spa.js", script);

const scriptTag = `<script${
  external ? ` src="node_modules/astro-spa/spa.js"` : ""
}>${external ? "" : script}</script>`;
---

{scriptTag}